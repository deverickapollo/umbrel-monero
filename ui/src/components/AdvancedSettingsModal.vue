<template v-slot:modal-header="{ close }" title="Advanced Settings">
  <b-form @submit.prevent="submit">
    <div
      class="px-0 px-sm-3 pb-3 d-flex flex-column justify-content-between w-100"
    >
      <h3 class="mt-1">Advanced Settings</h3>
      <b-alert variant="warning" show class="mb-3">
        <small>
          Be careful when changing the settings below as they may cause issues
          with other apps on your Umbrel that connect to your Monero node. Only
          make changes if you understand the potential effects on connected apps
          or wallets.
          <br />
        </small>
      </b-alert>

      <b-overlay :show="isSettingsDisabled" rounded="sm">
        <div
          class="advanced-settings-container d-flex flex-column p-3 pb-sm-3 bg-light mb-2"
        >
          <div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="w-75">
                <label class="mb-0" for="tor">
                  <p class="font-weight-bold mb-0">
                    Outgoing Connections to Tor Peers
                  </p>
                </label>
              </div>
              <div>
                <toggle-switch
                  id="tor"
                  class="align-self-center"
                  :on="settings.tor"
                  @toggle="status => (settings.tor = status)"
                ></toggle-switch>
              </div>
            </div>
            <small class="w-sm-75 d-block text-muted mt-1">
              Connect to peers available on the Tor network.
            </small>
          </div>

          <hr class="advanced-settings-divider" />
          <!-- 
          <div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="w-75">
                <label class="mb-0" for="I2P">
                  <p class="font-weight-bold mb-0">
                    Outgoing Connections to I2P Peers
                  </p>
                </label>
              </div>
              <div>
                <toggle-switch
                  id="I2P"
                  class="align-self-center"
                  :on="settings.i2p"
                  @toggle="status => (settings.i2p = status)"
                ></toggle-switch>
              </div>
            </div>
            <small class="w-sm-75 d-block text-muted mt-1">
              Connect to peers available on the I2P network.
            </small>
          </div>

          <hr class="advanced-settings-divider" /> -->

          <div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="w-75">
                <label class="mb-0" for="dbsalvage">
                  <p class="font-weight-bold mb-0">Salvage Database</p>
                </label>
              </div>
              <div>
                <toggle-switch
                  id="dbsalvage"
                  class="align-self-center"
                  :on="settings.dbSalvage"
                  @toggle="status => (settings.dbSalvage = status)"
                ></toggle-switch>
              </div>
            </div>
            <small class="w-sm-75 d-block text-muted mt-1">
              Salvage the monero database if it is corrupted.
            </small>
          </div>

          <!-- <hr class="advanced-settings-divider" />

          <div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="w-75">
                <label class="mb-0" for="p2pFullNode">
                  <p class="font-weight-bold mb-0">Enable P2P Full Node</p>
                </label>
              </div>
              <div>
                <toggle-switch
                  id="p2pFullNode"
                  class="align-self-center"
                  :on="settings.p2pFullNode"
                  @toggle="status => (settings.p2pFullNode = status)"
                ></toggle-switch>
              </div>
            </div>
            <small class="w-sm-75 d-block text-muted mt-1">
              Enable P2P Full Node (default is false)
            </small>
          </div> -->

          <hr class="advanced-settings-divider" />

          <div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="w-75">
                <label class="mb-0" for="public-node">
                  <p class="font-weight-bold mb-0">Public Node</p>
                </label>
              </div>
              <div>
                <toggle-switch
                  id="public-node"
                  class="align-self-center"
                  :on="settings.publicNode"
                  @toggle="status => (settings.publicNode = status)"
                ></toggle-switch>
              </div>
            </div>
            <small class="w-sm-75 d-block text-muted mt-1">
              Advertise to the network that your node is public. This feature
              will disable most RPC calls so only use if you know what you are
              doing.
            </small>
          </div>

          <hr class="advanced-settings-divider" />

          <div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="w-75">
                <label class="mb-0" for="hidePort">
                  <p class="font-weight-bold mb-0">Hide Port</p>
                </label>
              </div>
              <div>
                <toggle-switch
                  id="hidePort"
                  class="align-self-center"
                  :on="settings.hidePort"
                  @toggle="
                    status => {
                      settings.hidePort = status;
                    }
                  "
                ></toggle-switch>
              </div>
            </div>
            <small class="w-sm-75 d-block text-muted mt-1">
              Do not announce yourself as peerlist candidate
            </small>
          </div>

          <hr class="advanced-settings-divider" />

          <div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="w-75">
                <label class="mb-0" for="mining">
                  <p class="font-weight-bold mb-0">
                    Enable mining on the server
                  </p>
                </label>
              </div>
              <div>
                <toggle-switch
                  id="mining"
                  class="align-self-center"
                  :on="settings.mining"
                  @toggle="status => (settings.mining = status)"
                ></toggle-switch>
              </div>
            </div>
            <small class="w-sm-75 d-block text-muted mt-1">
              Specify maximum percentage cpu use by miner
            </small>
            <miner-slider
              id="miner-cpu"
              class="mt-3 mb-3"
              :minValue="1"
              :maxValue="100"
              :startingValue="33"
              :disabled="!settings.mining"
              @change="value => (settings.minercpuTarget = value)"
            ></miner-slider>
          </div>

          <hr v-if="settings.mining" class="advanced-settings-divider" />

          <div v-if="settings.mining">
            <div class="d-flex justify-content-between align-items-center">
              <div class="w-75">
                <label class="mb-0" for="moneroAddress">
                  <p class="font-weight-bold mb-0">Monero Address</p>
                </label>
              </div>
              <div>
                <b-form-input
                  id="moneroAddress"
                  v-model="settings.moneroAddress"
                  type="text"
                  placeholder="Enter your Monero address"
                ></b-form-input>
              </div>
            </div>
            <small class="w-sm-75 d-block text-muted mt-1">
              Set your Monero address for mining rewards.
            </small>
          </div>

          <hr v-if="settings.mining" class="advanced-settings-divider" />

          <div v-if="settings.mining">
            <div class="d-flex justify-content-between align-items-center">
              <div class="w-75">
                <label class="mb-0" for="p2pool">
                  <p class="font-weight-bold mb-0">Monero P2Pool</p>
                </label>
              </div>
              <div>
                <toggle-switch
                  id="p2pool"
                  class="align-self-center"
                  :on="settings.p2pool"
                  @toggle="
                    status => {
                      settings.p2pool = status;
                    }
                  "
                ></toggle-switch>
              </div>
            </div>
            <small class="w-sm-75 d-block text-muted mt-1">
              Enable Monero P2Pool. Full restart required.
            </small>
          </div>

          <hr class="advanced-settings-divider" />

          <div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="w-75">
                <label class="mb-0" for="zmq">
                  <p class="font-weight-bold mb-0">Enable ZMQ Support</p>
                </label>
              </div>
              <div>
                <toggle-switch
                  id="zmq"
                  class="align-self-center"
                  :on="settings.zmq"
                  @toggle="status => (settings.zmq = status)"
                ></toggle-switch>
              </div>
            </div>
            <small class="w-sm-75 d-block text-muted mt-1">
              ZMQ support is required for P2Pool support
            </small>
          </div>

          <hr class="advanced-settings-divider" />

          <div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="w-75">
                <label class="mb-0" for="upnp">
                  <p class="font-weight-bold mb-0">Enable UPnP on Node</p>
                </label>
              </div>
              <div>
                <toggle-switch
                  id="upnp"
                  class="align-self-center"
                  :on="settings.upnp"
                  @toggle="status => (settings.upnp = status)"
                ></toggle-switch>
              </div>
            </div>
            <small class="w-sm-75 d-block text-muted mt-1">
              Enable UPnP (default is true)
            </small>
          </div>

          <hr class="advanced-settings-divider" />

          <div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="w-75">
                <label class="mb-0" for="prune">
                  <p class="font-weight-bold mb-0">Prune node</p>
                </label>
              </div>
              <div>
                <toggle-switch
                  id="prune"
                  class="align-self-center"
                  :on="settings.prune"
                  @toggle="status => (settings.prune = status)"
                ></toggle-switch>
              </div>
            </div>
            <small class="w-sm-75 d-block text-muted mt-1">
              Enable Pruning
            </small>
          </div>

          <hr class="advanced-settings-divider" />

          <div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="w-75">
                <label class="mb-0" for="btcpayserver">
                  <p class="font-weight-bold mb-0">Enable Monero Support for BTCPayServer</p>
                </label>
              </div>
              <div>
                <toggle-switch
                  id="btcpayserver"
                  class="align-self-center"
                  :on="settings.btcpayserver"
                  @toggle="status => (settings.btcpayserver = status)"
                ></toggle-switch>
              </div>
            </div>
            <small class="w-sm-75 d-block text-muted mt-1">
              Enable Monero for BTCPayServer
            </small>
          </div>

          <hr class="advanced-settings-divider" />

          <div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="w-75">
                <label class="mb-0" for="checkpoint">
                  <p class="font-weight-bold mb-0">
                    Enable DNS Checkpointing on Node
                  </p>
                </label>
              </div>
              <div>
                <toggle-switch
                  id="checkpoint"
                  class="align-self-center"
                  :on="settings.checkpoint"
                  @toggle="status => (settings.checkpoint = status)"
                ></toggle-switch>
              </div>
            </div>
            <small class="w-sm-75 d-block text-muted mt-1">
              Enable DNS checkpoint (default is true)
            </small>
          </div>

          <hr class="advanced-settings-divider" />

          <div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="w-75">
                <label class="mb-0" for="allow-incoming-connections">
                  <p class="font-weight-bold mb-0">Incoming Connections</p>
                </label>
              </div>
              <div>
                <toggle-switch
                  id="allow-incoming-connections"
                  class="align-self-center"
                  :on="settings.incomingConnections"
                  @toggle="status => (settings.incomingConnections = status)"
                ></toggle-switch>
              </div>
            </div>
            <small class="w-sm-75 d-block text-muted mt-1">
              Broadcast your node to the Monero network to help other nodes
              access the blockchain. You may need to set up port forwarding on
              your router to allow incoming connections from clearnet-only
              peers.
            </small>
          </div>

          <hr class="advanced-settings-divider" />

          <div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="w-75">
                <label class="mb-0" for="dbSyncMode">
                  <p class="font-weight-bold mb-0">DB Sync Mode</p>
                </label>
              </div>
              <div class="">
                <b-form-select
                  id="dbSyncMode"
                  v-model="settings.dbSyncMode"
                  :options="dbSyncMode"
                ></b-form-select>
              </div>
            </div>
            <small class="w-sm-75 d-block text-muted mt-1">
              Configure database synchronization mode for your node. Adjusting
              these settings can help you optimize the performance of your
              Monero node, particularly during the initial blockchain
              synchronization and ongoing block validation.
            </small>
          </div>

          <hr class="advanced-settings-divider" />

          <div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="w-75">
                <label class="mb-0" for="network">
                  <p class="font-weight-bold mb-0">Network</p>
                </label>
              </div>

              <div>
                <b-form-select
                  id="network"
                  v-model="settings.network"
                  :options="networks"
                ></b-form-select>
              </div>
            </div>
          </div>
          <small class="w-sm-75 d-block text-muted mt-1">
            Choose which network you want your Monero node to connect to. If you
            change the network, restart your Umbrel to make sure any apps
            connected to your Monero node continue to work properly.
          </small>

          <hr class="advanced-settings-divider" />

          <div class="row">
            <div
              class="col-12 col-md-8 col-sm-12 d-flex flex-column align-items-start mb-md-0"
            >
              <p class="font-weight-bold mb-0">Monero Donation Address</p>
              <small class=" d-block text-muted mt-1 mb-3">
                To support our developers, please consider donating to our
                Monero address. Funds will go towards development of this app
                and other Monero apps on Umbrel.
              </small>
            </div>
            <div
              class="col-12 col-md-4 col-sm-12 d-flex justify-content-center justify-content-md-end align-items-center"
            >
              <donation></donation>
            </div>
          </div>

          <hr class="advanced-settings-divider" />

          <!-- <div class="row">
            <div
              class="col-12 col-md-8 col-sm-12 d-flex flex-column align-items-start mb-md-0"
            >
              <p class="font-weight-bold mb-0">Support & Feedback</p>
              <small class=" d-block text-muted mt-1 mb-3">
                Follow me on Twitter
                <a href="https://twitter.com/deverickapollo" target="_blank"
                  >@deverickapollo</a
                >
              </small>
            </div>
            <div
              class="col-12 col-md-4 col-sm-12 d-flex justify-content-center justify-content-md-end align-items-center"
            >
              <div ref="address" class="d-none">{{ address }}</div>
              <donation></donation>
            </div>
          </div> -->
          <div class="row">
            <div
              class="col-12 col-md-8 col-sm-12 d-flex flex-column align-items-start mb-md-0"
            >
              <p class="font-weight-bold mb-0">Support & Feedback</p>
              <small class="d-block text-muted mt-1 mb-3">
                Encountered an issue or have a feature request?
              </small>
              <small class="d-block text-muted mt-1 mb-3">
                Please submit all requests to
                <a
                  href="https://github.com/deverickapollo/umbrel-monero/issues/new"
                  target="_blank"
                >
                  Github
                </a>
                and follow me on Twitter
                <a href="https://twitter.com/deverickapollo" target="_blank"
                  >@deverickapollo</a
                >
                to stay updated on upcoming releases.
              </small>
            </div>
          </div>
        </div>
        <!-- template overlay with empty div to show an overlay with no spinner -->
        <template #overlay>
          <div></div>
        </template>
      </b-overlay>

      <b-alert
        variant="warning"
        :show="showOutgoingConnectionsError"
        class="mt-2"
        @dismissed="showOutgoingConnectionsError = false"
      >
        <small>
          Please choose at least one source for outgoing connections (Clearnet
          or Tor).
        </small>
      </b-alert>

      <b-alert
        variant="warning"
        :show="showMiningError"
        class="mt-2"
        @dismissed="showMiningError = false"
      >
        <small>
          Please enter a valid Monero address.
        </small>
      </b-alert>

      <b-alert
        variant="warning"
        :show="showBTCPayError"
        class="mt-2"
        @dismissed="showBTCPayError = false"
      >
        <small>
          Please first enable BTCPayServer app to enable Monero support.
        </small>
      </b-alert>

      <div class="mt-2 mb-2">
        <b-row>
          <b-col cols="12" lg="6">
            <b-button
              @click="clickRestoreDefaults"
              class="btn-border"
              variant="outline-secondary"
              block
              :disabled="isSettingsDisabled"
            >
              Restore Default Settings</b-button
            >
          </b-col>
          <b-col cols="12" lg="6">
            <b-button
              class="mt-2 mt-lg-0"
              variant="success"
              type="submit"
              block
              :disabled="isSettingsDisabled"
            >
              Save and Restart Monero Node</b-button
            >
          </b-col>
        </b-row>
      </div>
    </div>
  </b-form>
</template>

<script lang="ts">
import cloneDeep from "lodash.clonedeep";
import { mapState } from "vuex";
import ToggleSwitch from "./Utility/ToggleSwitch.vue";
import { MoneroUtils } from "monero-ts"; 
import MinerSlider from "./MinerSlider.vue";
import Donation from "@/components/DonationModal.vue";

export default {
  name: "AdvancedSettingsModal",
  data() {
    return {
      settings: {
        minercpu: { enabled: false },
        btcpayserver: false,
        tor: true,
        i2p: false,
        p2pool: false,
        zmq: false,
        prune: false,
        dbSalvage: false,
        p2pFullNode: false,
        publicNode: false,
        hidePort: false,
        mining: false,
        moneroAddress: "",
        upnp: false,
        checkpoint: false,
        incomingConnections: false,
      },
      dbSyncMode: [
        { value: "fastest", text: "fastest" },
        { value: "fast", text: "fast" },
        { value: "safe", text: "safe" }
      ],
      networks: [
        { value: "mainnet", text: "mainnet" },
        { value: "test", text: "testnet" },
        { value: "stagenet", text: "stagenet" }
      ],
      showOutgoingConnectionsError: false,
      showMiningError: false,
      showBTCPayError: false
    };
  },
  computed: {
    ...mapState({
      moneroConfig: state => state.user.moneroConfig,
      rpc: state => state.monero.rpc,
      p2p: state => state.monero.p2p
    })
  },
  props: {
    isSettingsDisabled: {
      type: Boolean,
      default: false
    }
  },
  created() {
    this.setSettings();
  },
  components: {
    ToggleSwitch,
    MinerSlider,
    Donation
  },
  methods: {
    async submit() {
      this.showOutgoingConnectionsError = false;
      this.showMiningError = false;
      this.showBTCPayError = false;
      const addressVerification = await this.isValidAddress(
        this.settings.moneroAddress
      );
      if (!this.isOutgoingConnectionsValid())
        return (this.showOutgoingConnectionsError = true);
      //Here we need to verify the monero address is valid
      if (this.settings.mining && !addressVerification)
        return (this.showMiningError = true);
      //If enabling btcpayserver support, verify that the btcpayserver app is installed
      if (this.settings.btcpayserver) {
        await this.checkDockerContainer();
        const isBTCPayRunning = this.$store.state.system.dockerImages['btcpayserver'];
        if (!isBTCPayRunning) {
          return (this.showBTCPayError = true);
        }
      }
      this.$emit("submit", this.settings);
    },
    clickRestoreDefaults() {
      if (
        window.confirm("Are you sure you want to restore the default settings?")
      ) {
        this.$emit("clickRestoreDefaults");
      }
    },
    setSettings() {
      // deep clone moneroConfig in order to properly reset state if user hides modal instead of clicking the save and restart button
      this.settings = cloneDeep(this.moneroConfig);
    },
    isOutgoingConnectionsValid() {
      return this.settings.tor;
      //return this.settings.tor || this.settings.i2p;
    },
    async isValidAddress(address) {
      const isValid = await MoneroUtils.isValidAddress(address, 0);
      if (isValid) return true;
      return false;
    },
    async checkDockerContainer() {
      await this.$store.dispatch('system/checkDockerContainer', 'btcpay-server_web_1');
    },
  }
};
</script>

<!-- removed scoped in order to place scrollbar on bootstrap-vue .modal-body. Increased verbosity on other classes-->
<style lang="scss">
.advanced-settings-container {
  border-radius: 1rem;
  .advanced-settings-divider {
    // same styles as bootstrap <b-dropdown-divider/>
    height: 0;
    margin: 1.25rem 0;
    overflow: hidden;
    border-top: 1px solid #e9ecef;
  }
  .advanced-settings-input {
    max-width: 75px;
  }
  // to remove arrows on number input field
  .advanced-settings-input::-webkit-outer-spin-button,
  .advanced-settings-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .advanced-settings-input[type="number"] {
    -moz-appearance: textfield;
  }
}

.btn-border {
  border: solid 1px !important;
}

.modal-body::-webkit-scrollbar {
  width: 5px;
}

.modal-body::-webkit-scrollbar-track {
  background: transparent;
  margin-block-end: 1rem;
}

.modal-body::-webkit-scrollbar-thumb {
  background-color: rgba(0, 0, 0, 0.4);
  border-radius: 10px;
}

.modal-body::-webkit-scrollbar-thumb:hover {
  background-color: rgba(0, 0, 0, 0.5);
}

/* sm breakpoint */
@media (min-width: 576px) {
  .w-sm-75 {
    width: 75% !important;
  }
}
</style>
